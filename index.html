<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus | Knowledge Fusion</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bgMain: 'var(--bg-main)',
                        bgSidebar: 'var(--bg-sidebar)',
                        bgItem: 'var(--bg-item)',
                        bgHover: 'var(--bg-hover)',
                        textMain: 'var(--text-main)',
                        textMuted: 'var(--text-muted)',
                        borderMain: 'var(--border-main)',
                        accent: 'var(--accent)',
                        accentHover: 'var(--accent-hover)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            /* Light Theme Defaults */
            --bg-main: #ffffff;
            --bg-sidebar: #f3f4f6;
            --bg-item: #ffffff;
            --bg-hover: #e5e7eb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-main: #e5e7eb;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --scroll-track: #f3f4f6;
            --scroll-thumb: #d1d5db;
        }

        html.dark {
            /* Dark Theme Defaults */
            --bg-main: #0f0f0f;
            --bg-sidebar: #111827;
            --bg-item: #111827;
            --bg-hover: #1f2937;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --border-main: #1f2937;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --scroll-track: #1f2937;
            --scroll-thumb: #4b5563;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

        /* Editor Styling */
        .markdown-preview h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; color: var(--text-main); }
        .markdown-preview h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: var(--text-main); }
        .markdown-preview p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-preview ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-preview blockquote { border-left: 4px solid var(--accent); padding-left: 1em; font-style: italic; color: var(--text-muted); margin-bottom: 1em; }
        .markdown-preview code { background-color: var(--bg-hover); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .markdown-preview pre { background-color: var(--bg-sidebar); padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; }
        .markdown-preview a { color: #60a5fa; text-decoration: underline; }
        .markdown-preview hr { border-color: var(--border-main); margin: 2em 0; }

        /* Wikilink */
        .wikilink {
            color: var(--accent);
            cursor: pointer;
            background: rgba(139, 92, 246, 0.1);
            padding: 0 4px;
            border-radius: 4px;
        }
        .wikilink.is-missing { color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        /* Sidebar Item States */
        .sidebar-item { cursor: pointer; user-select: none; }
        .sidebar-item:hover { background-color: var(--bg-hover); }
        .sidebar-item.active { background-color: var(--bg-hover); border-left: 3px solid var(--accent); font-weight: 600; color: var(--text-main); }
        .sidebar-item.selected { background-color: rgba(139, 92, 246, 0.2); }
        
        /* Drag and Drop Visuals */
        .drop-target { border: 2px dashed var(--accent); background-color: rgba(139, 92, 246, 0.1); }

        #graph-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 40; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-bgSidebar border-r border-borderMain flex flex-col flex-shrink-0 z-50 transition-colors duration-300">
        <div class="p-4 border-b border-borderMain flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-tight text-textMain"><i class="fa-solid fa-circle-nodes text-accent mr-2"></i>Nexus</h1>
            <button id="btn-theme" class="text-textMuted hover:text-accent transition-colors">
                <i class="fa-solid fa-moon"></i>
            </button>
        </div>
        
        <div class="p-2">
            <input type="text" id="search-input" placeholder="Search..." class="w-full bg-bgMain border border-borderMain rounded px-3 py-2 text-sm focus:outline-none focus:border-accent text-textMain placeholder-textMuted transition-colors">
        </div>

        <!-- Tree View -->
        <div id="file-tree" class="flex-1 overflow-y-auto p-2 space-y-0.5 text-sm" ondragover="handleDragOver(event)" ondrop="handleDrop(event, null)">
            <!-- Content injected by JS -->
        </div>

        <!-- Footer Actions -->
        <div class="p-3 border-t border-borderMain bg-bgSidebar">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <button id="btn-new-page" class="bg-accent hover:bg-accentHover text-white py-2 rounded text-xs font-bold transition-colors">
                    <i class="fa-solid fa-file mr-1"></i> New Page
                </button>
                <button id="btn-new-folder" class="bg-bgHover hover:bg-borderMain text-textMain py-2 rounded text-xs font-bold transition-colors">
                    <i class="fa-solid fa-folder mr-1"></i> Folder
                </button>
            </div>
            <div class="flex justify-between mt-3 text-textMuted text-xs">
                <button id="btn-export" class="hover:text-textMain"><i class="fa-solid fa-download"></i> Backup</button>
                <input type="file" id="file-import" class="hidden" accept=".json">
                <button id="btn-import" class="hover:text-textMain"><i class="fa-solid fa-upload"></i> Restore</button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full overflow-hidden bg-bgMain transition-colors duration-300">
        
        <!-- Top Bar -->
        <header class="h-14 bg-bgSidebar border-b border-borderMain flex items-center justify-between px-6 flex-shrink-0 z-50 transition-colors">
            <div class="flex items-center space-x-2 overflow-hidden flex-1">
                <input type="text" id="note-title" class="bg-transparent text-lg font-medium focus:outline-none text-textMain w-full placeholder-textMuted" placeholder="Untitled Page">
            </div>
            
            <div class="flex items-center space-x-3 text-sm">
                <span id="save-status" class="text-xs text-textMuted mr-2"></span>
                <button id="btn-delete" class="text-textMuted hover:text-red-400 transition-colors px-2" title="Delete Selected">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
                <div class="h-4 w-px bg-borderMain mx-2"></div>
                <button id="btn-toggle-view" class="text-textMuted hover:text-textMain px-3 py-1 rounded hover:bg-bgHover transition-colors flex items-center" title="Graph View">
                    <i class="fa-solid fa-share-nodes mr-2"></i> Graph
                </button>
            </div>
        </header>

        <!-- Workspace -->
        <div id="workspace" class="flex flex-1 overflow-hidden relative z-10">
            <textarea id="markdown-input" class="w-1/2 h-full bg-bgMain text-textMain p-8 resize-none focus:outline-none font-mono text-sm leading-relaxed border-r border-borderMain overflow-y-auto transition-colors" placeholder="Start typing..."></textarea>
            <div id="markdown-preview" class="w-1/2 h-full bg-bgMain text-textMain p-8 overflow-y-auto markdown-preview transition-colors"></div>
        </div>

        <!-- Graph -->
        <div id="graph-container">
            <canvas id="graph-canvas"></canvas>
            <div class="absolute top-4 right-4 bg-bgSidebar border border-borderMain p-2 rounded text-xs text-textMuted shadow-lg">
                <p>Drag to move â€¢ Scroll to zoom</p>
            </div>
            <button id="btn-close-graph" class="absolute top-4 left-4 bg-bgSidebar border border-borderMain text-textMain px-3 py-2 rounded shadow-lg hover:bg-bgHover z-50 text-xs font-bold">
                <i class="fa-solid fa-arrow-left mr-2"></i> Back
            </button>
        </div>

    </main>

    <script>
        // --- STATE ---
        let state = {
            notes: [],
            folders: [],
            selectedIds: new Set(), // Stores IDs of selected notes
            activeNoteId: null,
            isGraphOpen: false,
            theme: localStorage.getItem('nexus_theme') || 'dark'
        };

        // --- DOM ---
        const el = {
            tree: document.getElementById('file-tree'),
            title: document.getElementById('note-title'),
            editor: document.getElementById('markdown-input'),
            preview: document.getElementById('markdown-preview'),
            graphContainer: document.getElementById('graph-container'),
            graphCanvas: document.getElementById('graph-canvas'),
            searchInput: document.getElementById('search-input'),
            btnTheme: document.getElementById('btn-theme'),
            saveStatus: document.getElementById('save-status')
        };

        // --- INIT ---
        function init() {
            applyTheme(state.theme);
            loadData();
            
            if (state.notes.length === 0) {
                createNote('Welcome', '# Welcome to Nexus v2\n\nWe now have:\n- **Folders**: Create folders in the sidebar.\n- **Drag & Drop**: Move notes into folders.\n- **Multi-select**: Hold `Ctrl` to select multiple notes.\n- **Themes**: Toggle Dark/Light mode in the top left.\n');
            } else if (!state.activeNoteId) {
                setActiveNote(state.notes[0].id);
            } else {
                setActiveNote(state.activeNoteId);
            }
        }

        // --- THEME ENGINE ---
        function applyTheme(theme) {
            state.theme = theme;
            localStorage.setItem('nexus_theme', theme);
            document.documentElement.className = theme;
            const icon = el.btnTheme.querySelector('i');
            icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        }

        el.btnTheme.addEventListener('click', () => {
            applyTheme(state.theme === 'dark' ? 'light' : 'dark');
            // Redraw graph if open to update colors
            if (state.isGraphOpen) initGraph();
        });

        // --- DATA MANAGEMENT ---
        function loadData() {
            const raw = localStorage.getItem('nexus_data_v2');
            if (raw) {
                const data = JSON.parse(raw);
                state.notes = data.notes || [];
                state.folders = data.folders || [];
                // Legacy migration
                state.notes.forEach(n => { if(n.folderId === undefined) n.folderId = null; });
            }
        }

        function saveData() {
            const data = { notes: state.notes, folders: state.folders };
            localStorage.setItem('nexus_data_v2', JSON.stringify(data));
            el.saveStatus.innerText = 'Saved';
            setTimeout(() => el.saveStatus.innerText = '', 2000);
        }

        function generateId() { return Math.random().toString(36).substr(2, 9); }

        function createNote(title = "New Page", content = "") {
            const note = {
                id: generateId(),
                title: title,
                content: content,
                folderId: null, // Default to root
                timestamp: Date.now()
            };
            state.notes.unshift(note);
            saveData();
            setActiveNote(note.id);
            renderTree();
        }

        function createFolder() {
            const name = prompt("Folder Name:");
            if (name) {
                state.folders.push({
                    id: generateId(),
                    name: name,
                    isOpen: true
                });
                saveData();
                renderTree();
            }
        }

        // --- CORE OPERATIONS ---
        function setActiveNote(id) {
            state.activeNoteId = id;
            state.selectedIds.clear();
            state.selectedIds.add(id);
            
            const note = state.notes.find(n => n.id === id);
            if (note) {
                el.title.value = note.title;
                el.editor.value = note.content;
                updatePreview();
                renderTree();
            }
        }

        function updatePreview() {
            const raw = el.editor.value;
            const wikiLinkRegex = /\[\[(.*?)\]\]/g;
            const html = marked.parse(raw).replace(wikiLinkRegex, (match, p1) => {
                const exists = state.notes.some(n => n.title.toLowerCase() === p1.toLowerCase());
                const cls = exists ? 'wikilink' : 'wikilink is-missing';
                return `<span class="${cls}" onclick="handleWikiLink('${p1.replace(/'/g, "\\'")}')">${p1}</span>`;
            });
            el.preview.innerHTML = html;
            
            // Update data
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                note.content = raw;
                note.timestamp = Date.now();
                saveData();
            }
        }

        function handleWikiLink(title) {
            const target = state.notes.find(n => n.title.toLowerCase() === title.toLowerCase());
            if (target) setActiveNote(target.id);
            else createNote(title, `# ${title}\n\nLinked from another page.`);
        }

        function deleteSelection() {
            if(state.selectedIds.size === 0) return;
            if(!confirm(`Delete ${state.selectedIds.size} item(s)?`)) return;

            state.notes = state.notes.filter(n => !state.selectedIds.has(n.id));
            // Check folders too (if we allowed folder selection, implementing simple note deletion for now)
            
            if (state.notes.length > 0) setActiveNote(state.notes[0].id);
            else {
                el.title.value = "";
                el.editor.value = "";
                el.preview.innerHTML = "";
                state.activeNoteId = null;
            }
            saveData();
            renderTree();
        }

        // --- SIDEBAR TREE & DRAG DROP ---
        function toggleFolder(id) {
            const f = state.folders.find(f => f.id === id);
            if(f) {
                f.isOpen = !f.isOpen;
                saveData();
                renderTree();
            }
        }

        function handleDragStart(e, type, id) {
            // If dragging something not selected, select it first (unless ctrl is held)
            if (!state.selectedIds.has(id)) {
                state.selectedIds.clear();
                state.selectedIds.add(id);
                renderTree(); // Update visuals
            }
            e.dataTransfer.setData('application/json', JSON.stringify([...state.selectedIds]));
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const target = e.target.closest('.folder-drop-zone');
            if (target) target.classList.add('drop-target');
        }

        function handleDragLeave(e) {
            const target = e.target.closest('.folder-drop-zone');
            if (target) target.classList.remove('drop-target');
        }

        function handleDrop(e, targetFolderId) {
            e.preventDefault();
            // Clear visuals
            document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));

            const data = e.dataTransfer.getData('application/json');
            if (!data) return;
            
            const idsToMove = JSON.parse(data);
            
            // Move notes
            state.notes.forEach(n => {
                if(idsToMove.includes(n.id)) {
                    n.folderId = targetFolderId;
                }
            });
            
            saveData();
            renderTree();
        }

        function selectItem(e, id) {
            if (e.ctrlKey || e.metaKey) {
                // Toggle
                if (state.selectedIds.has(id)) {
                    state.selectedIds.delete(id);
                } else {
                    state.selectedIds.add(id);
                }
            } else {
                // Single Select
                setActiveNote(id); // This clears others
                return;
            }
            // Re-render to show selection
            renderTree();
        }

        function renderTree() {
            const container = el.tree;
            container.innerHTML = '';
            const filter = el.searchInput.value.toLowerCase();

            // Helper to render a note
            const renderNote = (note) => {
                const isSelected = state.selectedIds.has(note.id);
                const isActive = note.id === state.activeNoteId;
                const div = document.createElement('div');
                div.draggable = true;
                div.className = `sidebar-item flex items-center px-2 py-1.5 rounded my-0.5 text-textMuted hover:text-textMain transition-colors ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `<i class="fa-regular fa-file-lines mr-2 w-4 text-center text-xs"></i> <span class="truncate flex-1">${note.title || 'Untitled'}</span>`;
                
                div.onclick = (e) => selectItem(e, note.id);
                div.ondragstart = (e) => handleDragStart(e, 'note', note.id);
                
                return div;
            };

            // Helper to render folder
            const renderFolder = (folder) => {
                const notesInFolder = state.notes.filter(n => n.folderId === folder.id && n.title.toLowerCase().includes(filter));
                if (filter && notesInFolder.length === 0) return null; // Hide empty folders during search

                const div = document.createElement('div');
                div.className = 'mb-1';
                
                // Folder Header (Drop Zone)
                const header = document.createElement('div');
                header.className = 'folder-drop-zone flex items-center px-2 py-1.5 rounded text-textMain font-semibold cursor-pointer hover:bg-bgHover transition-colors';
                header.innerHTML = `<i class="fa-solid ${folder.isOpen ? 'fa-folder-open' : 'fa-folder'} mr-2 text-accent w-4 text-center"></i> <span class="truncate">${folder.name}</span>`;
                header.onclick = () => toggleFolder(folder.id);
                
                // Drag events for folder
                header.ondragover = handleDragOver;
                header.ondragleave = handleDragLeave;
                header.ondrop = (e) => handleDrop(e, folder.id);

                div.appendChild(header);

                // Folder Contents
                if (folder.isOpen || filter) {
                    const content = document.createElement('div');
                    content.className = 'pl-4 border-l border-borderMain ml-2';
                    notesInFolder.forEach(n => content.appendChild(renderNote(n)));
                    div.appendChild(content);
                }

                return div;
            };

            // 1. Render Folders
            state.folders.forEach(f => {
                const fEl = renderFolder(f);
                if (fEl) container.appendChild(fEl);
            });

            // 2. Render Root Notes
            const rootNotes = state.notes.filter(n => n.folderId === null && n.title.toLowerCase().includes(filter));
            rootNotes.forEach(n => container.appendChild(renderNote(n)));
        }

        // --- EVENT LISTENERS ---
        el.title.addEventListener('input', (e) => {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                note.title = e.target.value;
                saveData();
                renderTree();
            }
        });
        
        el.editor.addEventListener('input', updatePreview);
        el.searchInput.addEventListener('input', renderTree);
        document.getElementById('btn-new-page').addEventListener('click', () => createNote());
        document.getElementById('btn-new-folder').addEventListener('click', createFolder);
        document.getElementById('btn-delete').addEventListener('click', deleteSelection);

        // Import/Export
        document.getElementById('btn-export').addEventListener('click', () => {
            const dataStr = JSON.stringify({ notes: state.notes, folders: state.folders }, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `nexus_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        });
        document.getElementById('btn-import').addEventListener('click', () => document.getElementById('file-import').click());
        document.getElementById('file-import').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                localStorage.setItem('nexus_data_v2', ev.target.result);
                location.reload();
            };
            reader.readAsText(file);
        });

        // --- GRAPH VIEW (Force Directed) ---
        // Simplified for brevity, re-using logic but with Theme Colors
        let animationFrameId;
        let ctx = el.graphCanvas.getContext('2d');
        let transform = { x: 0, y: 0, k: 1 };
        let graphNodes = [], graphLinks = [];

        function initGraph() {
            const w = el.graphContainer.offsetWidth;
            const h = el.graphContainer.offsetHeight;
            el.graphCanvas.width = w;
            el.graphCanvas.height = h;
            
            graphNodes = state.notes.map(n => ({
                id: n.id, title: n.title,
                x: Math.random() * w, y: Math.random() * h,
                vx: 0, vy: 0
            }));

            graphLinks = [];
            state.notes.forEach(src => {
                const regex = /\[\[(.*?)\]\]/g;
                let match;
                while ((match = regex.exec(src.content)) !== null) {
                    const target = state.notes.find(n => n.title.toLowerCase() === match[1].toLowerCase());
                    if (target) graphLinks.push({ source: src.id, target: target.id });
                }
            });
            
            transform.x = w/2; transform.y = h/2;
            animateGraph();
        }

        function animateGraph() {
            if(!state.isGraphOpen) return;
            
            // Physics
            graphNodes.forEach(a => {
                graphNodes.forEach(b => {
                    if(a === b) return;
                    let dx = b.x - a.x, dy = b.y - a.y;
                    let dist = Math.sqrt(dx*dx + dy*dy) || 1;
                    if(dist < 200) {
                        let f = 200 / (dist*dist);
                        a.vx -= (dx/dist)*f; a.vy -= (dy/dist)*f;
                    }
                });
                a.vx *= 0.9; a.vy *= 0.9;
                a.x += a.vx; a.y += a.vy;
            });

            graphLinks.forEach(l => {
                let s = graphNodes.find(n => n.id === l.source);
                let t = graphNodes.find(n => n.id === l.target);
                if(s && t) {
                    let dx = t.x - s.x, dy = t.y - s.y;
                    s.vx += dx * 0.005; s.vy += dy * 0.005;
                    t.vx -= dx * 0.005; t.vy -= dy * 0.005;
                }
            });

            // Draw
            ctx.clearRect(0, 0, el.graphCanvas.width, el.graphCanvas.height);
            ctx.save();
            ctx.translate(transform.x, transform.y);
            ctx.scale(transform.k, transform.k);

            const style = getComputedStyle(document.body);
            const colorLine = style.getPropertyValue('--text-muted').trim();
            const colorNode = style.getPropertyValue('--text-main').trim();
            const colorAccent = style.getPropertyValue('--accent').trim();

            ctx.strokeStyle = colorLine;
            ctx.beginPath();
            graphLinks.forEach(l => {
                let s = graphNodes.find(n => n.id === l.source);
                let t = graphNodes.find(n => n.id === l.target);
                if(s && t) { ctx.moveTo(s.x, s.y); ctx.lineTo(t.x, t.y); }
            });
            ctx.stroke();

            graphNodes.forEach(n => {
                ctx.fillStyle = n.id === state.activeNoteId ? colorAccent : '#6b7280';
                ctx.beginPath();
                ctx.arc(n.x, n.y, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = colorNode;
                ctx.font = '10px Inter';
                ctx.fillText(n.title, n.x, n.y + 15);
            });
            ctx.restore();
            animationFrameId = requestAnimationFrame(animateGraph);
        }

        document.getElementById('btn-toggle-view').addEventListener('click', () => {
            state.isGraphOpen = true;
            el.graphContainer.style.display = 'block';
            initGraph();
        });
        document.getElementById('btn-close-graph').addEventListener('click', () => {
            state.isGraphOpen = false;
            el.graphContainer.style.display = 'none';
        });

        // Start
        init();

    </script>
</body>
</html>
