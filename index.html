<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus | Knowledge Fusion</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bgMain: 'var(--bg-main)',
                        bgSidebar: 'var(--bg-sidebar)',
                        bgItem: 'var(--bg-item)',
                        bgHover: 'var(--bg-hover)',
                        textMain: 'var(--text-main)',
                        textMuted: 'var(--text-muted)',
                        borderMain: 'var(--border-main)',
                        accent: 'var(--accent)',
                        tagColor: 'var(--tag-color)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            /* Light Theme Defaults */
            --bg-main: #ffffff;
            --bg-sidebar: #f9fafb;
            --bg-item: #ffffff;
            --bg-hover: #f3f4f6;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-main: #e5e7eb;
            --accent: #8b5cf6;
            --tag-color: #10b981; /* Emerald 500 */
            --scroll-track: #f3f4f6;
            --scroll-thumb: #d1d5db;
        }

        html.dark {
            /* Dark Theme Defaults */
            --bg-main: #0f0f0f;
            --bg-sidebar: #111827;
            --bg-item: #111827;
            --bg-hover: #1f2937;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --border-main: #1f2937;
            --accent: #8b5cf6;
            --tag-color: #34d399; /* Emerald 400 */
            --scroll-track: #1f2937;
            --scroll-thumb: #4b5563;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

        /* Editor Styling */
        .markdown-preview h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; color: var(--text-main); }
        .markdown-preview h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: var(--text-main); }
        .markdown-preview p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-preview ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-preview blockquote { border-left: 4px solid var(--accent); padding-left: 1em; font-style: italic; color: var(--text-muted); margin-bottom: 1em; }
        .markdown-preview code { background-color: var(--bg-hover); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .markdown-preview pre { background-color: var(--bg-sidebar); padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; }
        .markdown-preview a { color: #60a5fa; text-decoration: underline; }
        .markdown-preview hr { border-color: var(--border-main); margin: 2em 0; }

        /* Custom Inline Elements */
        .wikilink {
            color: var(--accent);
            cursor: pointer;
            background: rgba(139, 92, 246, 0.1);
            padding: 0 4px;
            border-radius: 4px;
            font-weight: 500;
        }
        .wikilink.is-missing { color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        .tag-pill {
            color: var(--tag-color);
            background: rgba(16, 185, 129, 0.1);
            padding: 0 6px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 500;
            margin-right: 2px;
            cursor: pointer;
        }
        .tag-pill:hover {
            background: rgba(16, 185, 129, 0.2);
            text-decoration: underline;
        }

        /* Sidebar */
        .sidebar-item { cursor: pointer; user-select: none; }
        .sidebar-item:hover { background-color: var(--bg-hover); }
        .sidebar-item.active { background-color: var(--bg-hover); border-left: 3px solid var(--accent); font-weight: 600; color: var(--text-main); }
        .sidebar-item.selected { background-color: rgba(139, 92, 246, 0.15); }
        
        .drop-target { border: 2px dashed var(--accent); background-color: rgba(139, 92, 246, 0.1); }

        #graph-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 40; }
        
        /* Graph Controls */
        .graph-controls {
            background: var(--bg-sidebar);
            border: 1px solid var(--border-main);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-bgSidebar border-r border-borderMain flex flex-col flex-shrink-0 z-50 transition-colors duration-300">
        <div class="p-4 border-b border-borderMain flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-tight text-textMain"><i class="fa-solid fa-circle-nodes text-accent mr-2"></i>Nexus</h1>
            <button id="btn-theme" class="text-textMuted hover:text-accent transition-colors" title="Toggle Theme">
                <i class="fa-regular fa-sun"></i>
            </button>
        </div>
        
        <div class="p-2">
            <input type="text" id="search-input" placeholder="Search..." class="w-full bg-bgMain border border-borderMain rounded px-3 py-2 text-sm focus:outline-none focus:border-accent text-textMain placeholder-textMuted transition-colors">
        </div>

        <!-- Tree View -->
        <div id="file-tree" class="flex-1 overflow-y-auto p-2 space-y-0.5 text-sm" ondragover="handleDragOver(event)" ondrop="handleDrop(event, null)">
            <!-- Content injected by JS -->
        </div>

        <!-- Footer Actions -->
        <div class="p-3 border-t border-borderMain bg-bgSidebar">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <button id="btn-new-page" class="bg-accent hover:bg-accentHover text-white py-2 rounded text-xs font-bold transition-colors shadow-sm">
                    <i class="fa-solid fa-file mr-1"></i> New Page
                </button>
                <button id="btn-new-folder" class="bg-white border border-borderMain hover:bg-bgHover text-textMain py-2 rounded text-xs font-bold transition-colors shadow-sm dark:bg-gray-800 dark:border-gray-700">
                    <i class="fa-solid fa-folder mr-1"></i> Folder
                </button>
            </div>
            <div class="flex justify-between mt-3 text-textMuted text-xs">
                <button id="btn-export" class="hover:text-textMain"><i class="fa-solid fa-download"></i> Backup</button>
                <input type="file" id="file-import" class="hidden" accept=".json">
                <button id="btn-import" class="hover:text-textMain"><i class="fa-solid fa-upload"></i> Restore</button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full overflow-hidden bg-bgMain transition-colors duration-300">
        
        <!-- Top Bar -->
        <header class="h-14 bg-bgSidebar border-b border-borderMain flex items-center justify-between px-6 flex-shrink-0 z-50 transition-colors">
            <div class="flex items-center space-x-2 overflow-hidden flex-1">
                <input type="text" id="note-title" class="bg-transparent text-lg font-medium focus:outline-none text-textMain w-full placeholder-textMuted" placeholder="Untitled Page">
            </div>
            
            <div class="flex items-center space-x-3 text-sm">
                <span id="save-status" class="text-xs text-textMuted mr-2"></span>
                <button id="btn-delete" class="text-textMuted hover:text-red-400 transition-colors px-2" title="Delete Selected">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
                <div class="h-4 w-px bg-borderMain mx-2"></div>
                <button id="btn-toggle-view" class="text-textMuted hover:text-textMain px-3 py-1 rounded hover:bg-bgHover transition-colors flex items-center bg-white border border-borderMain shadow-sm dark:bg-gray-800 dark:border-gray-700" title="Graph View">
                    <i class="fa-solid fa-share-nodes mr-2 text-accent"></i> Graph View
                </button>
            </div>
        </header>

        <!-- Workspace -->
        <div id="workspace" class="flex flex-1 overflow-hidden relative z-10">
            <textarea id="markdown-input" class="w-1/2 h-full bg-bgMain text-textMain p-8 resize-none focus:outline-none font-mono text-sm leading-relaxed border-r border-borderMain overflow-y-auto transition-colors" placeholder="Start typing... Use [[Link]] or #tag"></textarea>
            <div id="markdown-preview" class="w-1/2 h-full bg-bgMain text-textMain p-8 overflow-y-auto markdown-preview transition-colors"></div>
        </div>

        <!-- Graph -->
        <div id="graph-container">
            <canvas id="graph-canvas"></canvas>
            
            <!-- Left Controls -->
            <div class="absolute top-4 left-4 flex flex-col gap-2">
                 <button id="btn-close-graph" class="bg-white dark:bg-gray-800 border border-borderMain text-textMain px-4 py-2 rounded shadow-lg hover:bg-bgHover text-sm font-bold flex items-center">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Back to Editor
                </button>
                <div id="graph-filter-status" class="hidden bg-accent text-white px-3 py-2 rounded shadow-lg text-xs flex items-center justify-between">
                    <span>Filter: <b id="filter-tag-name"></b></span>
                    <button onclick="clearGraphFilter()" class="ml-2 hover:text-gray-200"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <!-- Right Controls -->
            <div class="absolute top-4 right-4 graph-controls flex flex-col gap-2 text-xs text-textMuted">
                <label class="flex items-center cursor-pointer hover:text-textMain">
                    <input type="checkbox" id="chk-show-tags" class="mr-2 accent-emerald-500" checked> 
                    Show Tags
                </label>
                <label class="flex items-center cursor-pointer hover:text-textMain">
                    <input type="checkbox" id="chk-freeze-graph" class="mr-2 accent-purple-500"> 
                    Freeze Nodes
                </label>
                <div class="h-px bg-borderMain my-1"></div>
                <p><i class="fa-solid fa-hand-pointer mr-1"></i> Drag nodes</p>
                <p><i class="fa-solid fa-magnifying-glass mr-1"></i> Scroll to zoom</p>
            </div>
        </div>

    </main>

    <script>
        // --- STATE ---
        let state = {
            notes: [],
            folders: [],
            selectedIds: new Set(),
            activeNoteId: null,
            isGraphOpen: false,
            theme: localStorage.getItem('nexus_theme') || 'light',
            // Graph specific settings
            graphShowTags: true,
            graphFilterTag: null,
            graphFrozen: false
        };

        // --- DOM ---
        const el = {
            tree: document.getElementById('file-tree'),
            title: document.getElementById('note-title'),
            editor: document.getElementById('markdown-input'),
            preview: document.getElementById('markdown-preview'),
            graphContainer: document.getElementById('graph-container'),
            graphCanvas: document.getElementById('graph-canvas'),
            searchInput: document.getElementById('search-input'),
            btnTheme: document.getElementById('btn-theme'),
            saveStatus: document.getElementById('save-status'),
            // Graph UI
            chkShowTags: document.getElementById('chk-show-tags'),
            chkFreezeGraph: document.getElementById('chk-freeze-graph'),
            filterStatus: document.getElementById('graph-filter-status'),
            filterTagName: document.getElementById('filter-tag-name')
        };

        // --- INIT ---
        function init() {
            applyTheme(state.theme);
            loadData();
            
            if (state.notes.length === 0) {
                createNote('Welcome to Nexus', '# Welcome to Nexus\n\nFeatures:\n- **Folders**: Click folder icons to toggle.\n- **Graph**: Now fully interactive with drag/zoom.\n- **Tags**: Click #tags (like #ideas) to filter the graph view.\n\nTry creating a [[New Page]] or add a tag!');
            } else {
                if (!state.activeNoteId || !state.notes.find(n => n.id === state.activeNoteId)) {
                     if(state.notes.length > 0) setActiveNote(state.notes[0].id);
                } else {
                    setActiveNote(state.activeNoteId);
                }
            }
        }

        // --- THEME ENGINE ---
        function applyTheme(theme) {
            state.theme = theme;
            localStorage.setItem('nexus_theme', theme);
            document.documentElement.className = theme;
            const icon = el.btnTheme.querySelector('i');
            icon.className = theme === 'dark' ? 'fa-regular fa-moon' : 'fa-regular fa-sun';
        }

        el.btnTheme.addEventListener('click', () => {
            applyTheme(state.theme === 'dark' ? 'light' : 'dark');
            if (state.isGraphOpen) initGraph();
        });

        // --- DATA ---
        function loadData() {
            const raw = localStorage.getItem('nexus_data_v2');
            if (raw) {
                const data = JSON.parse(raw);
                state.notes = data.notes || [];
                state.folders = data.folders || [];
                state.notes.forEach(n => { 
                    if(n.folderId === undefined) n.folderId = null; 
                    if(!n.tags) n.tags = [];
                });
            }
        }

        function saveData() {
            const data = { notes: state.notes, folders: state.folders };
            localStorage.setItem('nexus_data_v2', JSON.stringify(data));
            el.saveStatus.innerText = 'Saved';
            setTimeout(() => el.saveStatus.innerText = '', 2000);
        }

        function generateId() { return Math.random().toString(36).substr(2, 9); }

        function createNote(title = "New Page", content = "") {
            const note = {
                id: generateId(),
                title: title,
                content: content,
                folderId: null,
                tags: [],
                timestamp: Date.now()
            };
            state.notes.unshift(note);
            saveData();
            setActiveNote(note.id);
            renderTree();
        }

        function createFolder() {
            const name = prompt("Folder Name:");
            if (name) {
                state.folders.push({ id: generateId(), name: name, isOpen: true });
                saveData();
                renderTree();
            }
        }

        // --- CORE OPERATIONS ---
        function setActiveNote(id) {
            const note = state.notes.find(n => n.id === id);
            if (!note) return;

            state.activeNoteId = id;
            state.selectedIds.clear();
            state.selectedIds.add(id);
            
            el.title.value = note.title;
            el.editor.value = note.content;
            updatePreview();
            renderTree();
            
            if (state.isGraphOpen) {
                state.isGraphOpen = false;
                el.graphContainer.style.display = 'none';
            }
        }

        // --- PARSING (WikiLinks & Tags) ---
        function updatePreview() {
            const raw = el.editor.value;
            let html = marked.parse(raw);
            
            // 1. Parse WikiLinks [[Page]]
            const wikiLinkRegex = /\[\[(.*?)\]\]/g;
            html = html.replace(wikiLinkRegex, (match, p1) => {
                const exists = state.notes.some(n => n.title.toLowerCase() === p1.toLowerCase());
                const cls = exists ? 'wikilink' : 'wikilink is-missing';
                return `<span class="${cls}" onclick="window.handleWikiLink('${p1.replace(/'/g, "\\'")}')">${p1}</span>`;
            });

            // 2. Parse Tags #tag
            const tagRegex = /(?<=^|\s)(#[a-zA-Z0-9_]+)/g;
            const foundTags = new Set();
            
            let tagMatch;
            while ((tagMatch = tagRegex.exec(raw)) !== null) {
                foundTags.add(tagMatch[0]);
            }

            // Replace with Clickable Pill
            html = html.replace(tagRegex, (match) => {
                return `<span class="tag-pill" onclick="window.handleTagClick('${match}')">${match}</span>`;
            });

            el.preview.innerHTML = html;
            
            // Update Note Data
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                note.content = raw;
                note.tags = [...foundTags];
                note.timestamp = Date.now();
                saveData();
            }
        }

        // Global Handlers
        window.handleWikiLink = (title) => {
            const target = state.notes.find(n => n.title.toLowerCase() === title.toLowerCase());
            if (target) setActiveNote(target.id);
            else createNote(title, `# ${title}\n\nLinked from another page.`);
        };

        window.handleTagClick = (tagName) => {
            state.graphFilterTag = tagName;
            // Force graph open
            state.isGraphOpen = true;
            el.graphContainer.style.display = 'block';
            initGraph();
        };
        
        window.clearGraphFilter = () => {
            state.graphFilterTag = null;
            initGraph();
        };

        window.toggleFolder = (id) => {
            const f = state.folders.find(f => f.id === id);
            if(f) {
                f.isOpen = !f.isOpen;
                saveData();
                renderTree();
            }
        };

        // --- TREE VIEW ---
        function renderTree() {
            const container = el.tree;
            container.innerHTML = '';
            const filter = el.searchInput.value.toLowerCase();

            const renderNote = (note) => {
                const isSelected = state.selectedIds.has(note.id);
                const isActive = note.id === state.activeNoteId;
                const div = document.createElement('div');
                div.draggable = true;
                div.className = `sidebar-item flex items-center px-2 py-1.5 rounded my-0.5 text-textMuted hover:text-textMain transition-colors ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `<i class="fa-regular fa-file-lines mr-2 w-4 text-center text-xs"></i> <span class="truncate flex-1">${note.title || 'Untitled'}</span>`;
                
                div.onclick = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        state.selectedIds.has(note.id) ? state.selectedIds.delete(note.id) : state.selectedIds.add(note.id);
                    } else {
                        setActiveNote(note.id);
                    }
                    renderTree();
                };
                div.ondragstart = (e) => {
                    if (!state.selectedIds.has(note.id)) { state.selectedIds.clear(); state.selectedIds.add(note.id); }
                    e.dataTransfer.setData('application/json', JSON.stringify([...state.selectedIds]));
                };
                return div;
            };

            const renderFolder = (folder) => {
                const notesInFolder = state.notes.filter(n => n.folderId === folder.id && n.title.toLowerCase().includes(filter));
                if (filter && notesInFolder.length === 0) return null;

                const div = document.createElement('div');
                div.className = 'mb-1';
                
                const header = document.createElement('div');
                header.className = 'folder-drop-zone flex items-center px-2 py-1.5 rounded text-textMain font-semibold cursor-pointer hover:bg-bgHover transition-colors';
                header.innerHTML = `<i class="fa-solid ${folder.isOpen ? 'fa-folder-open' : 'fa-folder'} mr-2 text-accent w-4 text-center transition-all"></i> <span class="truncate select-none">${folder.name}</span>`;
                
                header.onclick = (e) => { e.stopPropagation(); window.toggleFolder(folder.id); };
                header.ondragover = (e) => { e.preventDefault(); header.classList.add('drop-target'); };
                header.ondragleave = () => header.classList.remove('drop-target');
                header.ondrop = (e) => {
                    e.preventDefault();
                    header.classList.remove('drop-target');
                    const ids = JSON.parse(e.dataTransfer.getData('application/json') || '[]');
                    state.notes.forEach(n => { if(ids.includes(n.id)) n.folderId = folder.id; });
                    saveData(); renderTree();
                };

                div.appendChild(header);

                if (folder.isOpen || filter) {
                    const content = document.createElement('div');
                    content.className = 'pl-4 border-l border-borderMain ml-2';
                    notesInFolder.forEach(n => content.appendChild(renderNote(n)));
                    div.appendChild(content);
                }
                return div;
            };

            state.folders.forEach(f => { const el = renderFolder(f); if(el) container.appendChild(el); });
            const rootNotes = state.notes.filter(n => n.folderId === null && n.title.toLowerCase().includes(filter));
            
            if (rootNotes.length > 0 || state.folders.length > 0) {
               const rootContainer = document.createElement('div');
               rootContainer.className = "mt-2 pt-2 border-t border-borderMain folder-drop-zone";
               rootContainer.ondragover = (e) => e.preventDefault();
               rootContainer.ondrop = (e) => {
                   e.preventDefault();
                   const ids = JSON.parse(e.dataTransfer.getData('application/json') || '[]');
                   state.notes.forEach(n => { if(ids.includes(n.id)) n.folderId = null; });
                   saveData(); renderTree();
               };
               rootNotes.forEach(n => rootContainer.appendChild(renderNote(n)));
               container.appendChild(rootContainer);
            }
        }

        // --- GRAPH ENGINE (With Filters & Freeze) ---
        let ctx = el.graphCanvas.getContext('2d');
        let transform = { x: 0, y: 0, k: 1 };
        let nodes = [], links = [];
        let isDragging = false, dragStart = { x: 0, y: 0 }, draggedNode = null;
        let animationFrameId;
        
        // UI Listeners
        el.chkShowTags.addEventListener('change', (e) => { state.graphShowTags = e.target.checked; initGraph(); });
        el.chkFreezeGraph.addEventListener('change', (e) => { 
            state.graphFrozen = e.target.checked; 
            if(!state.graphFrozen) animateGraph(); // Resume
        });

        function initGraph() {
            const w = el.graphContainer.offsetWidth;
            const h = el.graphContainer.offsetHeight;
            el.graphCanvas.width = w;
            el.graphCanvas.height = h;
            
            // Reset Freeze on init usually implies movement reset, but let's keep user preference
            // if manual freeze is on, we don't simulate.

            // Update Filter UI
            if(state.graphFilterTag) {
                el.filterStatus.classList.remove('hidden');
                el.filterTagName.innerText = state.graphFilterTag;
            } else {
                el.filterStatus.classList.add('hidden');
            }

            // 1. Filter Sources
            let activeNotes = state.notes;
            if (state.graphFilterTag) {
                // Show only notes containing the tag
                activeNotes = state.notes.filter(n => n.tags.includes(state.graphFilterTag));
            }

            // 2. Create Nodes
            nodes = activeNotes.map(n => ({
                id: n.id, label: n.title, type: 'note',
                x: Math.random() * w, y: Math.random() * h, 
                vx: 0, vy: 0, radius: 6
            }));

            // 3. Add Tags (if enabled)
            // If filtering by a specific tag, ALWAYS show that tag node.
            // If not filtering, check checkbox.
            const shouldShowTags = state.graphShowTags || state.graphFilterTag;

            if (shouldShowTags) {
                const allTags = new Set();
                
                // Gather tags only from active notes to keep graph clean
                activeNotes.forEach(n => (n.tags || []).forEach(t => allTags.add(t)));
                
                allTags.forEach(tag => {
                    // If filtering, only show the filter tag (optional design choice, but safer to show all related)
                    // Let's show all tags that appear in the filtered notes, 
                    // BUT if we are strictly filtering, maybe only the relevant one?
                    // Let's show all tags connected to these visible notes for context.
                    
                    // Check if this tag should be visible
                    // If filtering: Show specific tag OR show all? 
                    // User asked: "show a graph view with nodes that with that tag only"
                    // Usually this means Central Tag Node <-> Note 1, Note 2...
                    
                    if (state.graphFilterTag && tag !== state.graphFilterTag) {
                         // If we are in filter mode, do we hide other tags?
                         // Let's keep it simple: Only show the specific tag node we filtered by?
                         // Or show others? Let's show only the filter tag to reduce noise.
                         return;
                    }
                    
                    nodes.push({
                        id: `tag_${tag}`, label: tag, type: 'tag',
                        x: Math.random() * w, y: Math.random() * h,
                        vx: 0, vy: 0, radius: 4
                    });
                });
            }

            // 4. Create Links
            links = [];
            activeNotes.forEach(src => {
                // Link to other visible notes
                const wikiRegex = /\[\[(.*?)\]\]/g;
                let match;
                while ((match = wikiRegex.exec(src.content)) !== null) {
                    const target = activeNotes.find(n => n.title.toLowerCase() === match[1].toLowerCase());
                    if (target) links.push({ source: src.id, target: target.id });
                }
                // Link to Tags
                if (shouldShowTags) {
                    (src.tags || []).forEach(tag => {
                        // Only link if tag node exists (filtered logic above)
                        if(nodes.find(n => n.id === `tag_${tag}`)) {
                            links.push({ source: src.id, target: `tag_${tag}` });
                        }
                    });
                }
            });

            transform.x = w/2; transform.y = h/2;
            if (!state.graphFrozen) animateGraph();
            else drawGraph();
        }

        function animateGraph() {
            if(!state.isGraphOpen || state.graphFrozen) return;

            const repulsion = 500;
            const spring = 0.005;
            let totalEnergy = 0;
            
            // Physics Calc
            for (let i=0; i<nodes.length; i++) {
                for (let j=i+1; j<nodes.length; j++) {
                    let dx = nodes[j].x - nodes[i].x;
                    let dy = nodes[j].y - nodes[i].y;
                    let d2 = dx*dx + dy*dy + 0.1;
                    if (d2 < 100000) {
                        let f = repulsion / d2;
                        let fx = (dx / Math.sqrt(d2)) * f;
                        let fy = (dy / Math.sqrt(d2)) * f;
                        nodes[j].vx += fx; nodes[j].vy += fy;
                        nodes[i].vx -= fx; nodes[i].vy -= fy;
                    }
                }
            }

            links.forEach(l => {
                let s = nodes.find(n => n.id === l.source);
                let t = nodes.find(n => n.id === l.target);
                if(s && t) {
                    let dx = t.x - s.x, dy = t.y - s.y;
                    s.vx += dx * spring; s.vy += dy * spring;
                    t.vx -= dx * spring; t.vy -= dy * spring;
                }
            });

            // Update & Damping
            nodes.forEach(n => {
                if (n !== draggedNode) {
                    n.x += n.vx; n.y += n.vy;
                    n.x -= n.x * 0.0015; n.y -= n.y * 0.0015; // Gentle gravity center
                }
                n.vx *= 0.80; n.vy *= 0.80; // Higher damping to settle faster
                totalEnergy += Math.abs(n.vx) + Math.abs(n.vy);
            });

            drawGraph();

            // Auto-freeze if energy is low
            if (totalEnergy < 0.2 && !isDragging) {
                // Stop loop, but don't check the freeze box
                // Just stop calling requestAnimationFrame
                return; 
            }
            
            animationFrameId = requestAnimationFrame(animateGraph);
        }

        function drawGraph() {
            ctx.clearRect(0, 0, el.graphCanvas.width, el.graphCanvas.height);
            ctx.save();
            ctx.translate(transform.x, transform.y);
            ctx.scale(transform.k, transform.k);

            const styles = getComputedStyle(document.body);
            const cLine = styles.getPropertyValue('--text-muted').trim();
            const cNode = styles.getPropertyValue('--text-main').trim();
            const cAccent = styles.getPropertyValue('--accent').trim();
            const cTag = styles.getPropertyValue('--tag-color').trim();

            ctx.lineWidth = 1;
            ctx.strokeStyle = cLine;
            ctx.beginPath();
            links.forEach(l => {
                let s = nodes.find(n => n.id === l.source);
                let t = nodes.find(n => n.id === l.target);
                if(s && t) { ctx.moveTo(s.x, s.y); ctx.lineTo(t.x, t.y); }
            });
            ctx.stroke();

            nodes.forEach(n => {
                ctx.beginPath();
                ctx.arc(n.x, n.y, n.radius, 0, Math.PI*2);
                
                if (n.type === 'tag') ctx.fillStyle = cTag;
                else if (n.id === state.activeNoteId) ctx.fillStyle = cAccent;
                else ctx.fillStyle = '#9ca3af';
                
                ctx.fill();

                ctx.fillStyle = cNode;
                ctx.font = (n.type==='tag' ? 'italic 8px' : '10px') + ' Inter';
                ctx.textAlign = 'center';
                ctx.fillText(n.label, n.x, n.y + n.radius + 12);
            });
            ctx.restore();
        }

        // --- EVENTS ---
        el.graphCanvas.addEventListener('mousedown', e => {
            const rect = el.graphCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - transform.x) / transform.k;
            const y = (e.clientY - rect.top - transform.y) / transform.k;
            
            draggedNode = nodes.find(n => {
                let dx = n.x - x, dy = n.y - y;
                return dx*dx + dy*dy < 100; 
            });

            if(draggedNode) {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY, isClick: true };
                if(!state.graphFrozen) animateGraph(); // Wake up physics
            } else {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY, isClick: false };
            }
        });

        el.graphCanvas.addEventListener('mousemove', e => {
            if(!isDragging) return;
            
            if(draggedNode) {
                dragStart.isClick = false;
                const rect = el.graphCanvas.getBoundingClientRect();
                draggedNode.x = (e.clientX - rect.left - transform.x) / transform.k;
                draggedNode.y = (e.clientY - rect.top - transform.y) / transform.k;
                draggedNode.vx = 0; draggedNode.vy = 0;
                if(!state.graphFrozen) animateGraph(); // Keep waking
            } else {
                transform.x += e.clientX - dragStart.x;
                transform.y += e.clientY - dragStart.y;
                dragStart.x = e.clientX; dragStart.y = e.clientY;
                drawGraph(); // Just redraw, no physics needed for pan
            }
        });

        el.graphCanvas.addEventListener('mouseup', () => {
            if(draggedNode && dragStart.isClick) {
                if(draggedNode.type === 'note') setActiveNote(draggedNode.id);
            }
            isDragging = false;
            draggedNode = null;
        });

        el.graphCanvas.addEventListener('wheel', e => {
            e.preventDefault();
            const s = 0.001;
            const d = -e.deltaY * s;
            const newK = Math.min(Math.max(0.1, transform.k + d), 5);
            transform.k = newK;
            drawGraph();
        });

        el.title.addEventListener('input', (e) => {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) { note.title = e.target.value; saveData(); renderTree(); }
        });
        el.editor.addEventListener('input', updatePreview);
        el.searchInput.addEventListener('input', renderTree);
        
        document.getElementById('btn-new-page').addEventListener('click', () => createNote());
        document.getElementById('btn-new-folder').addEventListener('click', createFolder);
        document.getElementById('btn-delete').addEventListener('click', () => {
             if(state.selectedIds.size === 0) return;
             if(!confirm("Delete selected?")) return;
             state.notes = state.notes.filter(n => !state.selectedIds.has(n.id));
             saveData(); 
             if(state.notes.length > 0) setActiveNote(state.notes[0].id);
             else { el.title.value=''; el.editor.value=''; el.preview.innerHTML=''; }
        });
        document.getElementById('btn-toggle-view').addEventListener('click', () => {
            state.isGraphOpen = true;
            el.graphContainer.style.display = 'block';
            state.graphFilterTag = null; // Reset filter on general open
            initGraph();
        });
        document.getElementById('btn-close-graph').addEventListener('click', () => {
            state.isGraphOpen = false;
            el.graphContainer.style.display = 'none';
        });

        init();

    </script>
</body>
</html>
